<template>
  <div class="flexcol">
    <!-- HEADER -->
    <header class="sheet-header flexrow nogrow" style="gap: 5px">
      <document-img :document="item" />
      <document-name :document="item" />
    </header>

    <select
      class="nogrow"
      v-model="item.data.subtype"
      @change="subtypeChange"
      style="margin: 0.5rem 0"
    >
      <option value="vow">{{ $t('IRONSWORN.DOCUMENT.Vow') }}</option>
      <option value="progress">
        {{ $t('IRONSWORN.DOCUMENT.Progress') }}
      </option>
      <option value="bond">{{ $t('IRONSWORN.DOCUMENT.Connection') }}</option>
    </select>

    <hr class="nogrow" />
    <label class="checkbox nogrow">
      <input
        type="checkbox"
        v-model="item.data.completed"
        @change="saveChecks"
      />
      {{ $t('IRONSWORN.PROGRESS.COMPLETE.MARK.Label') }}
    </label>
    <hr class="nogrow" />

    <div class="nogrow">
      <label class="checkbox">
        <input
          type="checkbox"
          v-model="item.data.hasTrack"
          @change="saveChecks"
        />
        {{ $t('IRONSWORN.PROGRESS.Track') }}
      </label>

      <transition name="slide">
        <div class="nogrow" v-if="item.data.hasTrack">
          <!-- RANK -->
          <div class="flexrow nogrow">
            <rank-hexes
              :current="item.data.rank"
              @click="setRank"
              class="nogrow"
              style="margin-right: 1em"
            />
            <h4>{{ rankText }}</h4>
            <btn-faicon
              class="block nogrow"
              v-if="editMode"
              icon="trash"
              @click="clearProgress"
            />
            <btn-faicon
              class="block nogrow"
              icon="caret-right"
              @click="markProgress"
            />
          </div>
          <!-- PROGRESS -->
          <div class="flexrow track nogrow" style="margin-bottom: 1em">
            <progress-track :ticks="item.data.current" />
          </div>
        </div>
      </transition>
    </div>

    <hr class="nogrow" />

    <div class="nogrow">
      <label class="checkbox">
        <input
          type="checkbox"
          v-model="item.data.hasClock"
          @change="saveChecks"
        />
        {{ $t('IRONSWORN.DOCUMENT.Clock') }}
      </label>

      <transition name="slide">
        <div class="flexrow nogrow" v-if="item.data.hasClock">
          <div class="nogrow" style="margin: 0 1rem">
            <clock
              :wedges="item.data.clockMax"
              :ticked="item.data.clockTicks"
              @click="setClock"
            />
          </div>
          <div class="flexcol">
            {{ $t('IRONSWORN.CLOCK.SEGMENT.Title') }}
            <select
              class="nogrow"
              v-model="item.data.clockMax"
              @change="clockMaxChange"
              style="margin: 0.5rem 0"
            >
              <option value="4">4</option>
              <option value="6">6</option>
              <option value="8">8</option>
              <option value="10">10</option>
              <option value="12">12</option>
            </select>
          </div>
        </div>
      </transition>
    </div>

    <hr class="nogrow" />

    <!-- DESCRIPTION -->
    <mce-editor
      v-model="item.data.description"
      @save="saveDescription"
      @change="throttledSaveDescription"
    />
  </div>
</template>

<style lang="less" scoped>
.slide-enter-active,
.slide-leave-active {
  max-height: 93px;
}
</style>

<script setup lang="ts">
import { computed, inject, provide } from 'vue'
import { RANKS, RANK_INCREMENTS } from '../constants'
import { $ItemKey } from './provisions'
import DocumentImg from './components/document-img.vue'
import DocumentName from './components/document-name.vue'
import RankHexes from './components/rank-hexes/rank-hexes.vue'
import BtnFaicon from './components/buttons/btn-faicon.vue'
import ProgressTrack from './components/progress/progress-track.vue'
import Clock from './components/clock.vue'
import MceEditor from './components/mce-editor.vue'
import { throttle } from 'lodash'

const $item = inject($ItemKey)

const props = defineProps<{ item: any }>()
provide(
  'item',
  computed(() => props.item)
)

const editMode = computed(
  () => props.item.flags['foundry-ironsworn']?.['edit-mode']
)

const rankText = computed(() =>
  game.i18n.localize(RANKS[props.item.data.rank] + '.Label')
)

function setRank(rank) {
  $item?.update({ data: { rank } })
}

function clearProgress() {
  $item?.update({ 'data.current': 0 })
}

function markProgress() {
  const increment = RANK_INCREMENTS[props.item.data.rank]
  const newValue = Math.min(props.item.data.current + increment, 40)
  $item?.update({ 'data.current': newValue })
}

function subtypeChange() {
  $item?.update({ data: { subtype: props.item.data.subtype } })
}

function clockMaxChange() {
  $item?.update({ data: { clockMax: props.item.data.clockMax } })
}

function saveChecks() {
  $item?.update({
    data: {
      completed: props.item.data.completed,
      hasTrack: props.item.data.hasTrack,
      hasClock: props.item.data.hasClock,
    },
  })
}

function setClock(num) {
  $item?.update({ data: { clockTicks: num } })
}

function saveDescription() {
  $item?.update({ data: { description: props.item.data.description } })
}
const throttledSaveDescription = throttle(saveDescription, 1000)
</script>
